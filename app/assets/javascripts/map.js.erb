$(document).ready(function(){

  var MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoiYXJlbGVuZ2xpc2giLCJhIjoiY2l6ZzNrNHZ3MDB1cDMzb3dqdmh3emhjbSJ9.1WoDWsWNnIg-Wq8LPf1j-A';
  var MAPBOX_STYLE_ID = 'cj68kq87a1gqk2srsnul2iwee';
  var MAPBOX_USERNAME = 'arelenglish';
  var url = 'https://api.mapbox.com/styles/v1/' + MAPBOX_USERNAME + '/' + MAPBOX_STYLE_ID + '/tiles/256/{z}/{x}/{y}?access_token=' + MAPBOX_ACCESS_TOKEN;

  var viewer = new Cesium.Viewer('cesiumContainer', {
    timeline: false,
    animation: false,
    geocoder: false,
    baseLayerPicker: false,
    imageryProvider: new Cesium.UrlTemplateImageryProvider({
      url: url
    })
  });

  var terrainProvider = new Cesium.CesiumTerrainProvider({
    url : '//assets.agi.com/stk-terrain/world',
    requestVertexNormals : true // required for terrain lighting
  });
  // viewer.scene.globe.depthTestAgainstTerrain = true;
  viewer.terrainProvider = terrainProvider;

  var whichPage = $('#current_page').data('page');
  var basePath = window.location.protocol + "//" + window.location.host;

  if (whichPage === "homepage") {
    $.getJSON( basePath + "/api/v1/flights", function( data ) {
      renderMap(data);
    });
  } else {
    $.getJSON( basePath + "/api/v1/users/" + whichPage + "/flights", function( data ) {
      renderMap(data);
    });
  }

  var airportIcon = "<%= asset_path('airport.png') %>";
  var waypointIcon = "<%= asset_path('waypoint.png') %>";
  var billboards = new Cesium.BillboardCollection();

  function renderMap(data) {
    var max_count = data["max_count"];
    // Cesium.GeoJsonDataSource.load(data, {
    //   stroke: Cesium.Color.fromBytes(0, 230, 240, 40),
    //   markerSize: 0
    // }).then(function(dataSource) {
    // //   viewer.dataSources.add(dataSource);
    //   viewer.zoomTo(dataSource);
    // })
    for (var i = 0; i < data.features.length; i++) {
      var entity = data.features[i];
      if (entity.properties.feature_type === "airport") {
        var lat = entity.geometry.coordinates[1];
        var lon = entity.geometry.coordinates[0];
        billboards.add({
          position : new Cesium.Cartesian3.fromDegrees(lon, lat, 0),
          image : airportIcon,
          horizontalOrigin : Cesium.HorizontalOrigin.CENTER,
          verticalOrigin : Cesium.VerticalOrigin.CENTER,
          eyeOffset : new Cesium.Cartesian3( 0, 0, -100 ),
          color : new Cesium.Color.fromHsl(0, 0, 1, setOpacity(max_count, entity))
        })
      }
      if (entity.properties.feature_type === "waypoint") {
        var lat = entity.geometry.coordinates[1];
        var lon = entity.geometry.coordinates[0];
        billboards.add({
          position : new Cesium.Cartesian3.fromDegrees(lon, lat, 0),
          image : waypointIcon,
          horizontalOrigin : Cesium.HorizontalOrigin.CENTER,
          verticalOrigin : Cesium.VerticalOrigin.CENTER,
          eyeOffset : new Cesium.Cartesian3( 0, 0, -100 ),
          color : new Cesium.Color.fromHsl(0, 0, 1, setOpacity(max_count, entity))
        })
      }
      if (entity.properties.feature_type === "line") {
        var coordinates = [].concat.apply([], entity.geometry.coordinates)
        viewer.entities.add({
          polyline : {
            positions : Cesium.Cartesian3.fromDegreesArray(coordinates),
            width : 5,
            material : Cesium.Color.fromBytes(0, 230, 240, 40)
          }
        });
      }
    }
    viewer.scene.primitives.add(billboards);
  }

  function setOpacity(max_count, entity) {
    var opacity = Math.max((entity.properties.count/max_count) * 12, 0.3)
    if (opacity > 1) {
      opacity = 1
    }
    return opacity
  }

});
