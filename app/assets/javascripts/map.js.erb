$(document).ready(function(){
  var MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoiYXJlbGVuZ2xpc2giLCJhIjoiY2l6ZzNrNHZ3MDB1cDMzb3dqdmh3emhjbSJ9.1WoDWsWNnIg-Wq8LPf1j-A';
  var MAPBOX_STYLE_ID = 'cj68kq87a1gqk2srsnul2iwee';
  var MAPBOX_USERNAME = 'arelenglish';
  var url = 'https://api.mapbox.com/styles/v1/' + MAPBOX_USERNAME + '/' + MAPBOX_STYLE_ID + '/tiles/256/{z}/{x}/{y}?access_token=' + MAPBOX_ACCESS_TOKEN;

  var viewer = new Cesium.Viewer('cesiumContainer', {
    timeline : false,
    animation : false,
    geocoder: false,
    imageryProvider: new Cesium.UrlTemplateImageryProvider({
      url : url
    }),
    baseLayerPicker: false
  });

  var terrainProvider = new Cesium.CesiumTerrainProvider({
    url : '//assets.agi.com/stk-terrain/world',
    requestVertexNormals : true // required for terrain lighting
  });
  // viewer.scene.globe.depthTestAgainstTerrain = true;
  viewer.terrainProvider = terrainProvider;

  var whichPage = $('#current_page').data('page');
  var basePath = window.location.protocol + "//" + window.location.host;

  if (whichPage === "homepage") {
    $.getJSON( basePath + "/api/v1/flights", function( data ) {
      renderMap(data);
    });
  } else {
    $.getJSON( basePath + "/api/v1/users/" + whichPage + "/flights", function( data ) {
      renderMap(data);
    });
  }

  var airportIcon = "<%= asset_path('airport.png') %>";
  var waypointIcon = "<%= asset_path('waypoint.png') %>";
  var billboards = viewer.scene.primitives.add(new Cesium.BillboardCollection());
  billboards.add({
    image : airportIcon
  });
  billboards.add({
    image : waypointIcon
  });

  function renderMap(data) {
    var promise = Cesium.GeoJsonDataSource.load(data, {
      stroke: Cesium.Color.fromBytes(0, 230, 240, 40),
      markerSize: 40,
      markerColor: Cesium.Color.fromBytes(0, 230, 240),
      markerSymbol: 'airfield'
    });
    promise.then(function(dataSource) {
      viewer.dataSources.add(dataSource);
      viewer.zoomTo(dataSource);
      var entities = dataSource.entities.values;

      for (var i = 0; i < entities.length; i++) {
        var entity = entities[i];
        var max_count = data["max_count"];
        if (entity.billboard != undefined) {
          if (entity.properties.feature_type._value === "airport") {
            entity.billboard = billboards.get(0);
          } else if (entity.properties.feature_type._value === "waypoint") {
            entity.billboard = billboards.get(1);
          }
          entity.billboard.horizontalOrigin = Cesium.HorizontalOrigin.CENTER;
          entity.billboard.verticalOrigin = Cesium.VerticalOrigin.CENTER;
          entity.billboard.eyeOffset = new Cesium.Cartesian3( 0, 0, -100 );
          entity.billboard.color = new Cesium.Color.fromHsl(0, 0, 1, setOpacity(max_count, entity));
        }
      }
    })
  }

  function setOpacity(max_count, entity) {
    var opacity = Math.max((entity.properties.count/max_count) * 12, 0.3)
    if (opacity > 1) {
      opacity = 1
    }
    return opacity
  }

});
