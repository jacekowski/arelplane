$(document).ready(function(){

  var MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoiYXJlbGVuZ2xpc2giLCJhIjoiY2l6ZzNrNHZ3MDB1cDMzb3dqdmh3emhjbSJ9.1WoDWsWNnIg-Wq8LPf1j-A';
  var MAPBOX_STYLE_ID = 'cj68kq87a1gqk2srsnul2iwee';
  var MAPBOX_USERNAME = 'arelenglish';
  var url = 'https://api.mapbox.com/styles/v1/' + MAPBOX_USERNAME + '/' + MAPBOX_STYLE_ID + '/tiles/256/{z}/{x}/{y}?access_token=' + MAPBOX_ACCESS_TOKEN;

  var viewer = new Cesium.Viewer('cesiumContainer', {
    timeline: false,
    animation: false,
    geocoder: false,
    baseLayerPicker: false,
    imageryProvider: new Cesium.UrlTemplateImageryProvider({
      url: url
    })
  });

  viewer.terrainProvider = Cesium.createWorldTerrain();
  // viewer.scene.globe.depthTestAgainstTerrain = true;

  var whichPage = $('#current_page').data('page');
  var basePath = window.location.protocol + "//" + window.location.host;

  if (whichPage === "homepage") {
    $.getJSON( basePath + "/api/v1/flights", function( data ) {
      renderMap(data);
    });
  } else {
    $.getJSON( basePath + "/api/v1/users/" + whichPage + "/flights", function( data ) {
      renderMap(data);
    });
  }

  var airportIcon = "<%= asset_path('airport.png') %>";
  var waypointIcon = "<%= asset_path('waypoint.png') %>";
  var billboards = new Cesium.BillboardCollection();

  function renderMap(data) {
    var top_airport_visit_count = data["max_count"];
    Cesium.GeoJsonDataSource.load(data, {
      stroke: Cesium.Color.fromBytes(0, 230, 240, 40),
      markerColor: Cesium.Color.fromHsl(0, 0, 0, 0)
    }).then(function(dataSource) {
      viewer.dataSources.add(dataSource);
      viewer.zoomTo(dataSource);
      var entities = dataSource.entities.values;
      for (var i = 0; i < entities.length; i++) {
        var feature_type = entities[i].properties.feature_type._value;
        if (feature_type === "airport") {
          setAirportIcon(entities[i], top_airport_visit_count);
        } else if (feature_type === "waypoint") {
          setWaypointIcon(entities[i], top_airport_visit_count);
        }
      }
    })
    viewer.scene.primitives.add(billboards);
  }

  function setAirportIcon(entity, top_airport_visit_count) {
    billboards.add({
      position : entity.position.getValue(viewer.clock.currentTime),
      image : airportIcon,
      horizontalOrigin : Cesium.HorizontalOrigin.CENTER,
      verticalOrigin : Cesium.VerticalOrigin.CENTER,
      eyeOffset : new Cesium.Cartesian3( 0, 0, -100 ),
      color : new Cesium.Color.fromHsl(0, 0, 1, setOpacity(top_airport_visit_count, entity))
    });
  }

  function setWaypointIcon(entity, top_airport_visit_count) {
    billboards.add({
      position : entity.position.getValue(viewer.clock.currentTime),
      image : waypointIcon,
      horizontalOrigin : Cesium.HorizontalOrigin.CENTER,
      verticalOrigin : Cesium.VerticalOrigin.CENTER,
      eyeOffset : new Cesium.Cartesian3( 0, 0, -100 ),
      color : new Cesium.Color.fromHsl(0, 0, 1, setOpacity(top_airport_visit_count, entity))
    });
  }

  function setOpacity(top_airport_visit_count, entity) {
    var opacity = Math.max((entity.properties.count/top_airport_visit_count) * 12, 0.3)
    if (opacity > 1) {
      opacity = 1
    }
    return opacity
  }

});
